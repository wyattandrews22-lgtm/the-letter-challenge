<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Letter Challenge Online</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #gameContainer {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      width: 600px;
      max-width: 90%;
      text-align: center;
    }
    button {
      margin: 8px;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      background: #007bff;
      color: white;
    }
    button:hover {
      background: #0056b3;
    }
    #letterGrid {
      display: grid;
      grid-template-columns: repeat(5, 50px);
      grid-gap: 6px;
      justify-content: center;
      margin: 15px 0;
    }
    .letter {
      background: #eee;
      padding: 12px;
      font-size: 20px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }
    #currentWord {
      margin: 10px 0;
      font-size: 22px;
      font-weight: bold;
    }
    #wordList {
      margin-top: 15px;
      max-height: 150px;
      overflow-y: auto;
      text-align: left;
    }
    .word {
      padding: 2px 0;
    }
    #scores {
      margin-top: 12px;
      font-size: 18px;
    }
    input[type=text] {
      padding: 6px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h1>Letter Challenge</h1>
    <div id="menu">
      <button onclick="startGame('basic')">‚ñ∂Ô∏è Basic Mode</button>
      <button onclick="startGame('terrible')">üî• Terrible Mode</button>
      <button onclick="startGame('versus')">‚öîÔ∏è Versus (Local)</button>
      <button onclick="startOnline()">üåç Versus Online</button>
    </div>
    <div id="onlineMenu" style="display:none;">
      <h3>Online Play</h3>
      <button onclick="quickMatch('versus')">üîé Quick Match</button><br>
      <input id="roomCode" placeholder="Room code">
      <button onclick="joinRoomFromInput()">Join Room</button>
      <button onclick="createRoom()">Create Room</button>
      <button onclick="backToMenu()">‚¨Ö Back</button>
      <p id="onlineStatus"></p>
    </div>
    <div id="gameArea" style="display:none;">
      <div id="letterGrid"></div>
      <div id="currentWord"></div>
      <button onclick="submitWord()">‚úÖ Submit Word</button>
      <button onclick="clearWord()">‚ùå Clear</button>
      <div id="scores"></div>
      <div id="wordList"></div>
      <button onclick="endGame()">üè† Menu</button>
    </div>
  </div>

  <script>
    // --- Local Game State ---
    let letters = [];
    let currentWord = "";
    let mode = "basic";
    let currentPlayer = 1;
    let p1Score = 0, p2Score = 0;
    let online = false;

    // --- Dictionary load (client side) ---
    let dictionary = new Set();
    fetch("words.txt").then(r => r.text()).then(t => {
      t.split(/\r?\n/).forEach(w => dictionary.add(w.trim().toLowerCase()));
    });

    function startGame(m) {
      mode = m;
      online = false;
      document.getElementById("menu").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      document.getElementById("onlineMenu").style.display = "none";
      generateLetters();
      updateScores();
      document.getElementById("wordList").innerHTML = "";
    }

    function generateLetters() {
      let size = (mode === "basic") ? 5 : (mode === "terrible") ? 10 : 20;
      letters = [];
      const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      for (let i = 0; i < size; i++) {
        letters.push(alpha[Math.floor(Math.random() * 26)]);
      }
      displayLetters(letters, mode === "versus" ? 4 : 1, mode === "versus" ? 5 : letters.length);
    }

    function displayLetters(arr, rows, cols) {
      let grid = document.getElementById("letterGrid");
      grid.innerHTML = "";
      grid.style.gridTemplateColumns = `repeat(${cols}, 50px)`;
      arr.forEach((l, i) => {
        let d = document.createElement("div");
        d.className = "letter";
        d.textContent = l;
        d.onclick = () => addLetter(l);
        grid.appendChild(d);
      });
    }

    function addLetter(l) {
      currentWord += l;
      document.getElementById("currentWord").textContent = currentWord;
    }
    function clearWord() {
      currentWord = "";
      document.getElementById("currentWord").textContent = "";
    }

    function submitWord() {
      if (online) {
        submitWordOnline(currentWord);
        clearWord();
        return;
      }
      if (!dictionary.has(currentWord.toLowerCase())) {
        alert("Not a valid word!");
        return;
      }
      let wl = document.getElementById("wordList");
      let d = document.createElement("div");
      d.className = "word";
      d.textContent = (mode === "versus" ? (currentPlayer === 1 ? "üü¢ " : "üîµ ") : "") + currentWord;
      wl.appendChild(d);
      if (mode === "versus") {
        if (currentPlayer === 1) p1Score += currentWord.length; else p2Score += currentWord.length;
        currentPlayer = currentPlayer === 1 ? 2 : 1;
      } else {
        p1Score += currentWord.length;
      }
      updateScores();
      clearWord();
    }

    function updateScores() {
      let s = document.getElementById("scores");
      if (mode === "versus" || online) {
        s.innerHTML = `<div id="p1Score">üü¢ Player 1: ${p1Score}</div>
                       <div id="p2Score">üîµ Player 2: ${p2Score}</div>`;
      } else {
        s.textContent = "Score: " + p1Score;
      }
    }

    function endGame() {
      document.getElementById("menu").style.display = "block";
      document.getElementById("gameArea").style.display = "none";
      document.getElementById("onlineMenu").style.display = "none";
      p1Score = 0; p2Score = 0; currentPlayer = 1; currentWord = "";
    }

    function startOnline() {
      document.getElementById("menu").style.display = "none";
      document.getElementById("onlineMenu").style.display = "block";
      document.getElementById("gameArea").style.display = "none";
    }
    function backToMenu() {
      document.getElementById("menu").style.display = "block";
      document.getElementById("onlineMenu").style.display = "none";
    }

    // --- Online Play (WebSocket client) ---
    let socket = null;
    let playerIndex = null;
    let roomId = null;

    function connectWS(cb){
      if(socket && socket.readyState === WebSocket.OPEN){ cb(); return; }
      const url = (location.hostname === "localhost") ? "ws://localhost:8080" : "wss://YOUR_SERVER_DOMAIN";
      socket = new WebSocket(url);
      socket.addEventListener("open", () => { console.log("WS open"); if(cb) cb(); });
      socket.addEventListener("message", (ev) => {
        const msg = JSON.parse(ev.data);
        const { type, payload } = msg;
        if(type === "matched" || type === "room-joined" || type === "game-start"){
          playerIndex = payload.playerIndex;
          roomId = payload.roomId || roomId;
          online = true;
          mode = "versus";
          p1Score = payload.state.p1Score;
          p2Score = payload.state.p2Score;
          document.getElementById("onlineMenu").style.display = "none";
          document.getElementById("gameArea").style.display = "block";
          applyState(payload.state);
        }
        if(type === "state-update"){ applyState(payload.state); }
        if(type === "waiting"){ document.getElementById("onlineStatus").textContent = "‚è≥ Waiting for opponent..."; }
        if(type === "error"){ alert(payload.message); }
        if(type === "peer-left"){ alert("Opponent left the game."); endGame(); }
      });
      socket.addEventListener("close", () => { console.log("WS closed"); });
    }

    function quickMatch(mode){
      connectWS(() => {
        socket.send(JSON.stringify({ type:"quick-match", payload:{ mode }}));
      });
    }
    function joinRoomFromInput(){
      const code = document.getElementById("roomCode").value.trim();
      if(!code) return;
      connectWS(() => {
        socket.send(JSON.stringify({ type:"join-room", payload:{ roomId: code, mode:"versus" }}));
      });
    }
    function createRoom(){
      connectWS(() => {
        socket.send(JSON.stringify({ type:"create-room" }));
        document.getElementById("onlineStatus").textContent = "‚úÖ Room created. Share code with friend.";
      });
    }

    function submitWordOnline(word){
      if(!socket || socket.readyState !== WebSocket.OPEN) { alert("Not connected"); return; }
      socket.send(JSON.stringify({ type:"submit-word", payload:{ word, playerIndex }}));
    }

    function applyState(state){
      letters = state.letters.slice();
      displayLetters(letters, 4, 5);
      p1Score = state.p1Score;
      p2Score = state.p2Score;
      updateScores();
      const wl = document.getElementById("wordList");
      wl.innerHTML = "";
      state.foundWords.forEach(f => {
        const d = document.createElement("div");
        d.textContent = (f.by === 1 ? "üü¢ " : "üîµ ") + f.word;
        d.className = "word";
        wl.appendChild(d);
      });
    }
  </script>
</body>
</html>
