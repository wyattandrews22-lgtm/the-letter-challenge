<script>
let socket = null;
let playerIndex = null;
let roomId = null;

function connectWS(){
  // Replace with your server URL after deployment
  const url = (location.hostname === "localhost") ? "ws://localhost:8080" : "wss://YOUR_SERVER_DOMAIN";
  socket = new WebSocket(url);

  socket.addEventListener("open", () => { console.log("WS open"); });
  socket.addEventListener("message", (ev) => {
    const msg = JSON.parse(ev.data);
    const { type, payload } = msg;
    if(type === "matched" || type === "room-joined" || type === "game-start"){
      // payload contains state and playerIndex
      playerIndex = payload.playerIndex || payload.playerIndex;
      roomId = payload.roomId || roomId;
      applyState(payload.state);
      // transition UI to game area
    }
    if(type === "state-update"){
      applyState(payload.state);
    }
    if(type === "waiting"){
      // show "waiting for opponent" UI
    }
    if(type === "error"){
      alert(payload.message || "Error from server");
    }
  });

  socket.addEventListener("close", () => {
    console.log("WS closed");
    // show disconnected status
  });
}

function quickMatch(mode){
  if(!socket || socket.readyState !== WebSocket.OPEN) connectWS();
  socket.addEventListener("open", () => {
    socket.send(JSON.stringify({ type:"quick-match", payload:{ mode }}));
  });
  if(socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify({ type:"quick-match", payload:{ mode }}));
  }
}

function joinRoom(code){
  if(!socket || socket.readyState !== WebSocket.OPEN) connectWS();
  socket.send(JSON.stringify({ type:"join-room", payload:{ roomId: code, mode: "versus" }}));
}

function submitWordOnline(word){
  if(!socket || socket.readyState !== WebSocket.OPEN) { alert("Not connected"); return; }
  socket.send(JSON.stringify({ type:"submit-word", payload:{ word, playerIndex }}));
}

function applyState(state){
  // update local UI from server state
  letters = state.letters.slice();
  displayLetters(letters, state.mode === 'versus' ? 4 : 1, state.mode === 'versus' ? 5 : letters.length);
  // update scores
  document.getElementById("p1Score").textContent = `ðŸŸ¢ Player 1: ${state.p1Score}`;
  document.getElementById("p2Score").textContent = `ðŸ”µ Player 2: ${state.p2Score}`;
  // update found words list
  const wl = document.getElementById("wordList");
  wl.innerHTML = "";
  state.foundWords.forEach(f => {
    const d = document.createElement("div");
    d.textContent = (f.by === 1 ? "ðŸŸ¢ " : "ðŸ”µ ") + f.word;
    d.className = "word";
    wl.appendChild(d);
  });
}
</script>
